# Distro协议

## 背景

服务发现注册中心，在当前微服务体系下，是十分重要的组件，服务之间感知对方服务的当前可正常提供服务的实例信息，必须从服务发现注册中心进行获取，因此对于服务注册发现中心组件的可用性，提出了很高的要求，需要在任何场景下，尽最大可能保证服务注册发现能力可以对外提供服务；同时 Nacos 的服务注册发现设计，采取了心跳可自动完成服务数据补偿的机制。如果数据丢失的话，是可以通过该机制快速弥补数据丢失。

因此，为了满足服务发现注册中心的可用性，强一致性的共识算法这里就不太合适了，因为强一致性共识算法能否对外提供服务是有要求的，如果当前集群可用的节点数没有过半的话，整个算法直接“罢工”，而最终一致共识算法的话，更多保障服务的可用性，并且能够保证在一定的时间内各个节点之间的数据能够达成一致。

基于以上Nacos社区自研了一种AP分布式协议—Distro协议，是专门面向临时实例设计的一种分布式协议。

## 设计思想

- Nacos的每个节点都是平等的可以处理写请求，同时将新数据同步到其他节点。
- 每个节点只负责部分数据，定时发送自己负责的数据的校验值到其他节点来保证数据的一致性。
- 每个节点独立处理读请求，及时从本地发出响应。

## 初始化

新加入的Distro节点会轮询所有Distro节点，拉取全量数据。

当完成全量拉取之后，每个Distro节点都维护了所有的实例数据。



在Distro集群启动之后，每个Distro间会定期发送心跳进行校验。（心跳信息是所有数据的元信息，因为需要保证在网络中数据传输的量级维持在一个较低水平）

一旦在数据校验过程中，某个Distro节点发现其他Distro节点与本地数据不一致，则会发起一次全量拉取，将数据补齐。

## 写操作

对于一个启动完成的Distro集群，在一起客户端发起写操作的流程中，当注册非持久化实例的写请求打到某个Distro节点时，它的处理流程如下：

- 判断是否自身负责的
- 如果是，则自己直接进行处理
- 否则，将转发到复杂的Distro节点进行处理

## 读操作

由于每台机器都存放了所有的全量数据，所以对于Distro的写操作，Distro节点会直接从本机读取数据进行返回。



这种机制保证了Distro协议可以作为一种AP协议，对于读操作可以进行及时响应。

## 总结

Distro协议是Nacos对于临时实例数据开发的一致性协议，将数据存储在每个Distro节点的缓存中，在启动时进行全量拉取数据，并且定期进行数据校验。

在Distro协议中，每个Distro节点都可以接收到读写请求，所有的Distro协议的请求分为三种：

- 当节点接收到属于该节点负责的实例写请求时，直接写入当前Distro节点。
- 当该节点接收到不属于该节点负责的实例的写请求时，将在集群内部进行路由，将请求转发给所负责的Distro节点，从而完成读写请求。
- 当节点接收到读请求时，都直接在当前Distro节点进行读取并返回。



